# 1. x86系统架构概览
## 1.1. 系统级体系结构概览
- Global and Local Descriptor Tables

    保护模式是指x86体系结构中的一种工作模式，它允许操作系统在处理器上运行多个程序，并提供了硬件支持来保护每个程序的内存和其他资源。
    
    在保护模式下，内存访问需要经过全局描述符表（GDT）或者可选的局部描述符表（LDT），这些表中包含了称为段描述符的条目。每个段描述符提供了段的基地址、访问权限、类型和使用信息。要访问段中的一个字节，必须提供一个段选择器和一个偏移量。
    
    段选择器提供了对段描述符的访问，在GDT或LDT中。从段描述符中，处理器获得了线性地址空间中段的基地址。然后，偏移量提供了相对于基地址的字节的位置。CPL被定义为当前执行代码段的保护级别。GDT和LDT的基地址的线性地址包含在GDTR和LDTR寄存器中。保护模式的机制可以用来访问任何有效的代码、数据或堆栈段，只要该段可以从处理器当前运行的特权级（CPL）访问。

- System Segments, Segment Descriptors, and Gates

    除了代码、数据和堆栈段组成程序或过程的执行环境之外，架构还定义了两个系统段：任务状态段（TSS）和LDT。TSS和LDT在GDT中都有为它们定义的段描述符。
    
    此外架构还定义了一组称为门（调用门、中断门、陷阱门和任务门）的特殊描述符。提供了一种受保护的方式去调用跨特权的系统调用或者处理程序。当权限较低的代码段需要访问更高权限的代码段时，程序有一个call gate的选择器，通过call gate，获取到目标代码段的段描述符以及偏移量，
    
    这些系统段和特殊描述符提供了保护的网关，使得访问系统过程和处理程序成为可能，它们可能在与应用程序和大多数过程不同的特权级别下运行。例如，通过调用门访问过程时，处理器会对访问权限进行检查，然后获取目标代码段的段选择器和代码段中的偏移量。如果调用需要更改特权级别，处理器会切换到相应特权级别的堆栈，并从任务状态段中获取新堆栈的段选择器。
    
    此外，门还促进了16位和32位代码段之间的转换。

- Task-State Segments and Task Gates

    TSS定义了任务的执行环境状态。它包括通用寄存器、段寄存器、EFLAGS寄存器、EIP寄存器和具有三个堆栈段（每个特权级别一个堆栈）的段选择器的状态。TSS还包括与任务关联的LDT的段选择器和分页结构层次结构的基地址。

    在受保护模式下，所有程序执行都发生在任务（称为当前任务）的上下文中。当前任务的TSS的段选择器存储在任务寄存器中。切换到任务的最简单方法是调用或跳转到新任务。在此情况下，CALL或JMP指令中给出了新任务的TSS的段选择器。在切换任务时，处理器执行以下操作：

    1. 将当前任务的状态存储在当前TSS中。


    2. 用新任务的段选择器加载任务寄存器。
   
    3. 通过GDT中的段描述符访问新TSS。
    4. 将新任务的状态从新TSS加载到通用寄存器、段寄存器、LDTR、控制寄存器CR3（分页结构层次结构的基地址）、EFLAGS寄存器和EIP寄存器中。
    5. 开始执行新任务。
   
    任务也可以通过任务门访问。任务门类似于调用门，只是它提供访问TSS而不是代码段的访问权限（通过段选择器）。

- Interrupt and Exception Handling

    外部中断、软件中断和异常通过中断描述符表（IDT）进行处理。IDT存储了一组门描述符，提供了访问中断和异常处理程序的方法。与GDT一样，IDT不是一个段。IDT基地址的线性地址包含在IDT寄存器（IDTR）中。

    在访问中断或异常处理程序之前，处理器首先从内部硬件、外部中断控制器或通过INT、INTO、INT 3或BOUND指令从软件中接收中断向量（中断号）。中断向量提供了IDT的索引。如果所选的门描述符是中断门或陷阱门，则通过类似于通过调用门调用过程的方式访问相关的处理程序。如果描述符是任务门，则通过任务切换访问处理程序。

- Memory Management
  
    系统支持直接物理寻址和虚拟地址寻址，当使用分页的时候，所有的代码，数据，堆栈，段都可以分页，但是只有最近访问的页会被保存在物理内存中。分页结构的物理基址保存在控制寄存器CR3中，分页结构中的条目决定了页的物理基址，访问权限和内存管理等信息。

- System Registers
  
    - EFLAGS寄存器中的系统标志和IOPL字段控制任务和模式切换、中断处理、指令跟踪和访问权限。
    - 控制寄存器（CR0、CR2、CR3和CR4）包含各种用于控制系统级操作的标志和数据字段。这些寄存器中的其他标志用于指示操作系统或执行体中特定处理器功能的支持。
    - 调试寄存器允许设置断点以用于调试程序和系统软件。
    - GDTR、LDTR和IDTR寄存器包含它们各自表的线性地址和大小。
    - 任务寄存器包含当前任务的TSS的线性地址和大小。
    - 特定型号寄存器。
    特定型号寄存器（MSRs）是一组主要提供给操作系统或执行体程序（即在特权级0运行的代码）使用的寄存器。这些寄存器控制调试扩展、性能监视计数器、机器检查体系结构和内存类型范围（MTRRs）等项目。这些寄存器的数量和功能因Intel 64和IA-32处理器系列的不同而异。
## 1.2. 实模式和保护模式转换

1. “实模式–保护模式”的跳转
    1. 关中断
    2. 打开地址线A20
    3. 置cr0寄存器的末位为1 (PE = 1)
    4. 实现跳转，进入到保护模式
2. “保护模式–实模式”的跳转  
    1. 从保护模式下的32位代码段跳转到16位代码段
    2. 在16位代码段下初始化所有段寄存器
    3. 置cr0的末位为0 (PE = 0)
    4. 实现跳转，返回到实模式

## 1.3. 80x86系统指令寄存器
1. EFLAGS 标志寄存器    
   
    EFLAGS 标志寄存器用来控制I/O，硬件终端，调试，任务切换和虚模式。只有相应的权限码能够修改其中的部分字节。

    EFLAGS寄存器的状态标志(0、2、4、6、7以及11位)，用于指示算术指令（如ADD, SUB, MUL以及DIV指令）的结果。

    1. TF(bit 8) [Trap flag] 将该位设置为1以允许单步调试模式，清零则禁用该模式。
    2. IF(bit 9) [Interrupt enable flag] 该标志用于控制处理器对可屏蔽中断请求(maskable interrupt requests)的响应。置1以响应可屏蔽中断，反之则禁止可屏蔽中断。
    3. IOPL(bits 12 and 13) [I/O privilege level field] 指示当前运行任务的I/O特权级(I/O privilege level)，正在运行任务的当前特权级(CPL)必须小于或等于I/O特权级才能允许访问I/O地址空间。这个域只能在CPL为0时才能通过POPF以及IRET指令修改。
    4. NT(bit 14) [Nested task flag] 这个标志控制中断链和被调用任务。若当前任务与前一个执行任务相关则置1，反之则清零。
    5. RF(bit 16) [Resume flag] 控制处理器对调试异常的响应。
    6. VM(bit 17) [Virtual-8086 mode flag] 置1以允许虚拟8086模式，清除则返回保护模式。
    7. C(bit 18) [Alignment check flag] 该标志以及在CR0寄存器中的AM位置1时将允许内存引用的对齐检查，以上两个标志中至少有一个被清零则禁用对齐检查。
    8. VIF(bit 19) [Virtual interrupt flag] 该标志是IF标志的虚拟镜像(Virtual image)，与VIP标志结合起来使用。使用这个标志以及VIP标志，并设置CR4控制寄存器中的VME标志就可以允许虚拟模式扩展(virtual mode extensions)
    9. VIP(bit 20) [Virtual interrupt pending flag] 该位置1以指示一个中断正在被挂起，当没有中断挂起时该位清零。[Software sets and clears this flag; the processor only reads it.]与VIF标志结合使用。
    10. ID(bit 21) [Identification flag] 程序能够设置或清除这个标志指示了处理器对CPUID指令的支持。
2. 内存管理寄存器
   处理器提供了4个内存管理寄存器（GDTR、LDTR、IDTR和TR），用于指定分段内存管理所使用的系统表的基地址。

    1. GDTR寄存器中用于存放全局描述符表GDT的32位线性基地址和16位表长度值。基地址指定GDT表中字节0在线性地址空间中的地址，表长度指明GDT表的字节长度值。指令LGDT和SGDT用于加载和保存GDTR寄存器的内容。在机器刚加电或处理器复位后，默认基地址设置为0，而长度被设置成0XFFFF，在保护模式初始化过程中必须给GDTR加载一个新值。
    2. LDTR寄存器中用于存放局部描述符LDT的32位线性基地址、16位段限长和描述符属性值。LLDT和SLDT分别用于加载和保存LDTR寄存器的段描述符部分。包含LDT表的段必须在GDT表中有一个段描述符项，当使用LLDT指令把含有LDT表段的选择符加载进LDTR时，LDT段描述符的段基地址、段限长度以及描述符属性会被自动加载到LDTR中。当进行任务切换时，处理器会把新任务的段选择符合段描述符自动加载近LDTR中。在机器刚加电或者处理复位后，基地址被默认设置为0，而长度值设置为0XFFFF。
    3. IDTR寄存器用于存放中断描述符表IDT的32位线性基地址和16位表长度值，指令LIDT和SIDT分别用于加载和保存IDTR寄存器的内容。在机器刚加电或者处理复位后，基地址被默认设置为0，而长度值设置为0XFFFF。
    4. TR寄存器用于存放当前任务TSS段的16位段选择符、32位基地址、16位段长度和描述符属性值。它引用GDT表中一个TSS类型的描述符。指令LTR和STR分别用于加载和保存TR寄存器的段选择符部分。当使用LTR指令把选择符加载近任务寄存器时，TSS描述符中的段基地址、段限长度以及描述符属性会被自动的加载到任务寄存器中。当执行任务切换时，处理器会把新任务TSS的段选择符和段描述符自动加载到TR寄存器中。
3. 控制寄存器
    控制寄存器决定了当前处理器的操作模式和当前正在处理的任务的特性

    1. CR0含有控制处理器操作模式和状态的系统控制标志
    2. CR1保留
    3. CR2含有导致页错误的线性地址
    4. CR3含有页目录表物理内存基地址，因此该寄存器也被称为页目录基地址寄存器PDBR

## 1.4. 系统指令
1. LGDT SGDT
   
    LGDT指令将GDT的入口地址装入GDTR寄存器，从此以后，CPU就根据此寄存器中的内容作为GDT的入口来访问GDT。GDTR中存放的是GDT在内存中的基地址和其表长界限。SGDT用于保存GDTR寄存器中的值。

2. LIDT SIDT
   
    用于加载和保存LDTR寄存器的段描述符部分，即段基址和段限长度。

3. LLDT SLDT

    用于加载和保存IDTR寄存器。

4. LTR STR
   
    TR寄存器用于存放当前任务TSS段的16位段选择符、32位基地址、16位段长度和描述符属性值。指令LTR和STR分别用于加载和保存TR寄存器的段选择符部分。
