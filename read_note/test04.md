# 4. 任务管理
## 4.1. 任务管理概述
* 什么是任务？
  
  任务是处理器可以调度、执行和挂起的工作单元。它可以用来执行一个程序、一个任务或进程、一个操作系统服务工具、一个中断或异常处理程序，或者一个内核或执行工具。
- 80x86 提供了哪些硬件支持？
  
  80x86 提供了一些硬件支持来保存任务状态、调度任务执行和从一个任务切换到另一个任务。这些支持包括任务状态段（TSS）、TSS 描述符、任务寄存器和任务门描述符。
- 描述符表中与任务相关的描述符有哪些？
  
    描述符表中与任务相关的描述符有三种：TSS 描述符、任务门描述符和调用门描述符。TSS 描述符用来指向任务状态段，任务门描述符用来指向另一个任务的 TSS 描述符，调用门描述符用来指向另一个特权级的代码段。
- 任务切换与过程调用的区别是什么？
  
    任务切换与过程调用的区别是：任务切换是在不同的执行环境之间切换，涉及到处理器状态和内存映射的改变；过程调用是在同一个执行环境内部切换，只涉及到堆栈和程序计数器的改变。
### 4.1.1. 任务的结构
- 一个任务由两个部分组成：任务执行空间和任务状态段（TSS）。
- 任务执行空间包括代码段，堆栈段和一个或多个数据段。如果操作系统或执行者使用处理器的特权级保护机制，则任务执行空间还为每个特权级提供单独的堆栈。
- 会有多个特权级栈空间是因为任务可能在不同的特权级运行，当发生特权级变化时，需要切换到相应的栈空间来保护数据和返回地址。

### 4.1.2. 任务状态
- 当前正在执行的任务状态包括哪些内容？
  
    1. 任务的当前执行空间，由段寄存器中的段选择子定义（CS, DS, SS, ES, FS 和 GS）。 
    2. 通用寄存器的状态。 
    3. EFLAGS 寄存器的状态。 
    4. EIP 寄存器的状态。 
    5. 控制寄存器 CR3 的状态。 
    6. 任务寄存器的状态。 
    7. LDTR 寄存器的状态。 
    8. I/O 映射基地址和 I/O 映射（包含在 TSS 中）。 
    9. 特权级 0，1 和 2 的堆栈指针（包含在 TSS 中）。 
    10. 指向先前执行的任务的链接（包含在 TSS 中）。
   
这些内容都是程序执行时必须的状态信息，通过这些信息，程序能够正确执行，并且可以根据需要进行任务切换和中断处理。保存这些状态信息的目的是为了在中断、任务切换、函数调用等操作时能够正确地恢复执行现场。
### 4.1.3. 任务的执行
软件或处理器可以通过以下方式之一将任务分派给执行：
- 使用CALL指令显式调用任务。
- 使用JMP指令显式跳转到任务。
- 处理器隐式调用中断处理程序任务。
- 隐式调用异常处理程序任务。
- 当EFLAGS寄存器中的NT标志被设置时，通过返回（使用IRET指令）。
对于所有IA-32处理器，任务都不是递归的。任务不能调用或跳转到自己。
## 4.2. 任务的数据结构
- 任务状态段（Task-State Segment，TSS）是在x86系统架构下用于保存任务上下文信息的数据结构。当任务切换时，CPU会将当前任务的上下文信息保存在当前任务的TSS中，并将下一个任务的上下文信息加载到TSS中。TSS中的信息可以包括寄存器状态、代码段、数据段、堆栈段等，以便在任务切换时快速恢复任务状态。

- TSS描述符是一个16字节的数据结构，用于描述一个TSS的属性。在GDT（全局描述符表）或LDT（局部描述符表）中定义一个TSS描述符。TSS描述符包含了TSS在内存中的地址和TSS的大小等信息。

- 任务寄存器是用于存储任务信息的寄存器，包括当前任务的选择子（选择子指向任务的TSS描述符）、任务状态标志寄存器、任务寄存器等。其中，任务状态标志寄存器（EFLAGS）中包含了CPU状态的各种标志位，如进位标志、溢出标志、中断标志等。任务寄存器包括指令指针（EIP）、堆栈指针（ESP）等，它们在任务切换时保存当前任务的上下文信息。
任务寄存器，这是一个特殊的寄存器，用于存储当前任务的信息。任务是一个可以被处理器切换的执行单元。任务寄存器有两部分：可见部分和不可见部分。可见部分包含一个段选择子，指向全局描述符表（GDT）中的一个任务状态段（TSS）描述符。不可见部分包含TSS描述符的副本，其中包括TSS的基地址，限制和属性。TSS包含任务的状态，例如寄存器和内存映射。处理器在执行任务切换时，使用任务寄存器来访问TSS。

- 任务门描述符（Task-Gate Descriptor）是一种特殊的门描述符，用于支持任务切换。任务门描述符包含了指向任务TSS描述符和任务入口点的选择子。在任务门描述符中，任务的TSS描述符选择子被称为TSS选择子，任务入口点选择子被称为目标选择子。任务门描述符可用于实现任务间的切换。当处理器执行任务门时，会根据TSS选择子加载TSS，并跳转到任务入口点开始执行。任务门描述符可以实现任务间的切换，因为在切换时，处理器会自动保存当前任务的上下文信息，并加载下一个任务的上下文信息。任务门描述符可以放在GDT，本地描述符表（LDT）或中断描述符表（IDT）中。IDT用于存储中断和异常处理程序的描述符。当发生中断或异常时，处理器可以通过IDT中的一个任务门切换到一个处理程序任务。
## 4.3. 任务切换
- 任务切换发生在操作系统内核的调度器中，当一个进程的时间片用完或者出现了某些事件，例如进程等待某些资源或者阻塞在 I/O 操作时，内核会选择另一个进程来运行，这就需要进行任务切换。另外，当一个进程调用了系统调用，请求内核执行某个任务时，也会发生任务切换。

- 在任务切换时，处理器会执行以下操作：

    1. 保存当前任务的上下文信息，包括通用寄存器、段寄存器、标志寄存器和指令指针等。

    2. 加载下一个任务的上下文信息。

    3. 切换到下一个任务执行。

- 当中断或异常向量指向 IDT 表中的中断门或陷阱门时，不一定会发生任务切换，这取决于门描述符的类型和特权级。如果门描述符是任务门描述符，那么处理器会进行任务切换；如果门描述符是中断门描述符或陷阱门描述符，那么处理器会在当前任务上下文中直接处理中断或异常。处理器会根据门描述符中定义的特权级检查当前任务的特权级，如果当前任务特权级小于门描述符中定义的特权级，那么处理器会进行特权级切换，然后才进行任务切换。
  ## 4.4. 任务链
- 如何判断任务是否嵌套？
  
  TSS（任务状态段）中的上一个任务链接字段（有时称为“后向链接”）和EFLAGS寄存器中的NT标志用于返回到先前的任务。EFLAGS.NT = 1表示当前正在执行的任务嵌套在另一个任务的执行中。
- 什么情况会发生任务嵌套？
  
    CALL指令、中断或异常引起任务切换时，新任务是嵌套的，如果JMP指令引起任务切换，则新任务不是嵌套的。
- 任务嵌套时修改了哪些标志位？

  EFLAGS.NT = 1表示当前正在执行的任务嵌套在另一个任务的执行中。当CALL指令、中断或异常引起任务切换时，处理器将当前TSS的段选择符复制到新任务的TSS的上一个任务链接字段中，并设置EFLAGS.NT = 1。如果软件使用IRET指令暂停新任务，则处理器检查EFLAGS.NT = 1；然后使用上一个任务链接字段中的值返回到先前的任务。参见图7-8。如果JMP指令引起任务切换，则新任务不是嵌套的。不使用上一个任务链接字段，EFLAGS.NT = 0。
- 任务嵌套时，如何返回前一任务？
  
  任务嵌套的情况下，处理器在中断或异常处理程序返回时会恢复先前的任务的状态，以便从先前的任务继续执行。为此，处理器会从当前任务的TSS中获取返回地址和上下文，然后使用IRET指令将控制权返回到先前的任务。如果是任务切换嵌套，处理器还需要使用TSS中的back link字段来找到先前任务的TSS，以便正确恢复先前任务的状态。
## 4.5. 任务地址空间
- 任务的地址空间由任务可以访问的段组成，包括TSS中引用的代码、数据、堆栈和系统段以及任务代码访问的任何其他段。这些段被映射到处理器的线性地址空间中，进而通过分页映射到处理器的物理地址空间中。
- 任务可以通过以下两种方式之一映射到线性地址空间和物理地址空间：
    - 所有任务共享一个线性到物理地址空间映射。 - 当未启用分页时，这是唯一的选择。没有分页，所有线性地址映射到相同的物理地址。启用分页时，可以通过为所有任务使用一个页目录来获得这种形式的线性到物理地址空间映射。如果支持按需分页虚拟内存，则线性地址空间可能超出可用的物理空间。
    - 每个任务都有自己的线性地址空间，映射到物理地址空间。- 通过为每个任务使用不同的页目录来实现这种映射形式。因为PDBR（控制寄存器CR3）在任务切换时被加载，所以每个任务可以有不同的页目录。
  
    不同任务的线性地址空间可以映射到完全不同的物理地址。如果不同页目录的条目指向不同的页表，页表指向不同的物理内存页，则任务不共享物理地址。

    使用任一映射任务线性地址空间的方法，所有任务的TSS必须位于物理空间的共享区域中，可供所有任务访问。这种映射是必需的，以便处理器在任务切换期间读取和更新TSS时，TSS地址的映射不会改变。GDT映射的线性地址空间也应该映射到物理空间的共享区域;否则，GDT的目的就会失败。
- 为了允许任务之间共享数据，可以使用以下技术创建共享的逻辑地址空间到物理地址空间的映射：

    - 通过GDT中的段描述符 — 所有任务必须能够访问GDT中的段描述符。如果GDT中的一些段描述符指向线性地址空间中映射到所有任务共享的物理地址空间中的段，则所有任务都可以共享这些段中的数据和代码。
    - 通过共享LDT — 如果两个或多个任务使用相同的LDT，并且它们TSS中的LDT字段指向相同的LDT，则它们可以共享LDT中指向映射到物理地址空间公共区域的段描述符指向的段。共享的段中的数据和代码可以在共享LDT的任务之间共享。这种共享方法比通过GDT共享更有选择性，因为共享可以限制在特定任务中。系统中的其他任务可能具有不允许它们访问共享段的不同LDT。
    - 通过映射到线性地址空间中的共同地址的不同LDT中的段描述符 — 如果每个任务的线性地址空间的这个共同区域映射到物理地址空间的相同区域，则这些段描述符允许任务共享段。这样的段描述符通常称为别名。这种共享方法比上述方法更有选择性，因为LDT中的其他段描述符可能指向独立的线性地址，而这些地址不是共享的。