# 3. 中断和异常处理
## 3.1. 中断和异常处理概述
- 中断和异常是指系统、处理器或当前执行的程序或任务中存在某种条件，需要处理器的注意。它们通常导致当前运行的程序或任务的执行强制转移到一个特殊的软件例程或任务，称为中断处理程序或异常处理程序。
    
- 处理器对中断或异常的响应称为服务或处理中断或异常。 中断在程序执行过程中随机发生，响应来自硬件的信号。系统硬件使用中断来处理处理器外部的事件，例如服务外围设备的请求。软件也可以通过执行INT n指令来生成中断。 
- 异常发生在处理器在执行指令时检测到错误条件时，例如除以零。处理器检测到各种错误条件，包括保护违规、页面错误和内部机器故障。Pentium 4、Intel Xeon、P6系列和Pentium处理器的机器检查架构也允许在检测到内部硬件错误和总线错误时生成机器检查异常。 
- 当接收到中断或检测到异常时，当前运行的过程或任务被挂起，而处理器执行中断或异常处理程序。当处理程序的执行完成时，处理器恢复执行被中断的过程或任务。被中断的过程或任务的恢复不会丢失程序连续性，除非无法从异常恢复或中断导致当前运行的程序终止。
- 在实模式下，中断向量表存储在物理内存地址0x0000处，长度为1KB。中断向量表包含256个中断向量，每个向量占4个字节，其中前2个字节是中断处理程序的偏移地址，后2个字节是中断处理程序所在的段地址（即中断处理程序的代码段选择子）。

- 在保护模式下，中断向量表存储在内存中的一个特殊的数据结构中，即中断描述符表（Interrupt Descriptor Table，IDT）。中断描述符表是一个由中断门描述符构成的数组，每个中断门描述符指向一个中断处理程序，其中包含该中断处理程序的代码段选择子、偏移地址以及处理程序所在的特权级别等信息。中断描述符表由特权级别为0的系统内核代码负责初始化和维护，且由于保护模式支持特权级别的切换，因此在不同的特权级别下，可能会存在不同的中断描述符表。

## 3.2. 有关中断和异常了解性的内容

- 中断和异常向量
  
    为了处理异常和中断，每个体系结构定义的异常和每个需要处理器特殊处理的中断条件都分配了一个唯一的标识号，称为向量号。处理器使用分配给异常或中断的向量号作为中断描述符表（IDT）的索引。该表提供了异常或中断处理程序的入口点。
- 中断源和异常源

    - 中断源
     
      处理器从两个来源接收中断：外部（硬件生成的）中断和软件生成的中断。外部中断是来自硬件设备的信号，需要处理器的注意，例如键盘按键或网络数据包到达。软件中断是程序中的指令，导致处理器切换到低级中断处理程序，例如系统调用或调试陷阱。外部中断通常是异步的和可屏蔽的，而软件中断通常是同步的和不可屏蔽的。
    - 异常源

        处理器从三个来源接收异常：处理器检测的程序错误异常，软件生成的异常和机器检查异常。处理器检测的程序错误异常是在执行指令时，CPU检测到异常情况时产生的，例如除以零或页面错误。软件生成的异常是由程序中的指令触发的，请求内核提供服务，例如系统调用或调试陷阱。机器检查异常是由影响CPU操作的硬件故障或错误引起的，例如内存损坏或总线错误。 
- 异常的分类：故障、陷阱和中止
  
    - 故障是一种通常可以纠正的异常，一旦纠正，就可以在不丢失程序连续性的情况下重新启动程序。当报告故障时，处理器将机器状态恢复到执行故障指令之前的状态。故障处理程序的返回地址（保存的CS和EIP寄存器的内容）指向故障指令，而不是指向故障指令之后的指令。 
    - 陷阱是在执行陷阱指令后立即报告的异常。陷阱允许在不丢失程序连续性的情况下继续执行程序或任务。陷阱处理程序的返回地址指向陷阱指令后要执行的指令。 
    - 中止是一种不一定报告导致异常的指令的精确位置，也不允许重新启动导致异常的程序或任务的异常。中止用于报告严重错误，例如硬件错误和系统表中的不一致或非法值。
- 程序或任务的重新执行
  
   - 在x86系统中，当出现异常或中断时，处理器会根据中断或异常的向量号在中断或异常向量表中查找对应的处理程序。在处理程序执行完毕后，程序或任务的重新执行会根据异常或中断的类型有所不同。

    - 对于故障或中止，重新执行会从引起异常或中断的指令重新开始执行，这通常需要对程序进行一些修改以修复引起异常或中断的问题。对于陷阱，重新执行会从引起异常或中断的下一条指令开始执行，通常是用于执行调试程序。

    - 如果中断或异常发生在任务（进程）中，重新执行会从任务的TSS（任务状态段）中的标志中确定下一个指令的位置。如果没有任务，则会从当前进程的上下文中恢复执行。

    - 在重新执行之前，处理器还会执行一些额外的操作，例如保存当前的程序状态，清除中断或异常的标志，并在必要时调用操作系统的调度程序以决定下一个要执行的程序或任务。
- 开启和禁止中断
    - 处理器根据EFLAGS寄存器中的IF和RF标志的状态，以及处理器的状态，禁止产生某些中断。
    - IF标志可以禁止处理器的INTR引脚或通过本地APIC接收的可屏蔽硬件中断的服务。当IF标志清零时，处理器禁止将INTR引脚或通过本地APIC传送的中断作为内部中断请求；当IF标志置位时，将INTR引脚或通过本地APIC传送的中断作为正常的外部中断处理。 IF标志不影响通过NMI引脚或通过本地APIC传送的非屏蔽中断（NMI）或传送模式NMI消息，也不影响处理器产生的异常。
    - IF标志可以分别用STI（设置中断使能标志）和CLI（清除中断使能标志）指令来设置或清除。这些指令只有在CPL小于或等于IOPL时才能执行。如果在CPL大于IOPL时执行它们，就会产生一般保护异常。
    - EFLAGS寄存器中的RF（恢复）标志控制处理器对指令断点条件的响应。当置位时，它阻止指令断点产生调试异常（#DB）；当清零时，指令断点会产生调试异常。RF标志的主要功能是防止处理器在指令断点上进入调试异常循环。
    - 处理器在执行MOV到SS指令或POP到SS指令之后，直到下一条指令之后的指令边界到达之前，禁止中断、调试异常和单步陷阱异常。所有其他故障仍然可以产生。如果使用LSS指令来修改SS寄存器的内容（这是修改该寄存器的推荐方法），则不会出现这个问题。
- 异常和中断的优先级
    - 如果在一个指令边界处有多个异常或中断处于待处理状态，处理器会按照一定的顺序来处理它们
    - 处理器首先处理优先级最高的类别中的待处理异常或中断，将执行转移到处理程序的第一条指令。优先级较低的异常被丢弃；优先级较低的中断被挂起。丢弃的异常在中断处理程序将执行返回到程序或任务中发生异常和/或中断的位置时重新生成。
## 3.3. 中断描述符表
- 中断描述符表（IDT）将每个异常或中断向量与用于处理相关异常或中断的过程或任务的门描述符相关联。与GDT和LDT一样，IDT是一个8字节描述符的数组（在保护模式下）

- 在获得中断处理程序的地址方面，可以通过设置中断描述符表中相应中断向量的描述符来指定。每个描述符中有一个指向中断处理程序的入口地址字段，通过该字段可以将中断向量与中断处理程序联系起来。

- 要设置中断描述符表寄存器，首先需要将中断描述符表的基地址存入IDTR寄存器中。处理器使用IDTR寄存器定位IDT。这个寄存器同时保存了IDT的32位基地址和16位限制。 LIDT（加载IDT寄存器）和SIDT（存储IDT寄存器）指令分别加载和存储IDTR寄存器的内容。通过加载IDTR寄存器的值，处理器可以正确地解析中断描述符表中的中断向量和中断处理程序的地址。
## 3.4. IDT 描述符
中断门、陷阱门和任务门的描述符格式如下：


![alt text](.\images\gate.png)

## 3.5. 中断与异常处理
- 中断过程调用的流程是怎样的？
  1. 中断触发：硬件或软件引发中断，CPU将当前运行的指令或状态压入堆栈。

  2. 中断向量定位：处理器通过中断向量号，从中断描述符表中找到对应的中断门描述符。
  3. 中断门描述符检查：处理器检查中断门描述符的特权级别是否符合当前代码段的特权级别，如果不符合则会引发“通用保护错误”异常。
  4. 中断门描述符中断处理程序地址获取：处理器从中断门描述符中获取中断处理程序的地址。
  5. 保存当前上下文：处理器保存当前任务的上下文（状态、程序计数器、寄存器等）到内存或任务状态段中，以便在中断处理完成后恢复执行。
  6. 切换堆栈：如果需要，处理器会切换堆栈，以便在中断处理程序执行期间使用专用堆栈。
  7. 中断处理程序执行：处理器跳转到中断处理程序的入口点，并执行中断处理程序。
  8. 中断处理程序退出：中断处理程序执行完成后，处理器从中断处理程序返回，并恢复先前保存的上下文。
  9. 恢复堆栈：如果需要，处理器将堆栈切换回先前的堆栈。
  10. 恢复执行：处理器从先前保存的程序计数器处恢复执行，并继续之前被中断的任务。
- 如何判断中断处理过程与被中断任务的优先级？
  
  中断和异常都有一个预定义的优先级，称为“特权级别”，存储在它们的描述符中。如果中断或异常的特权级别比当前代码段的特权级别更高，则处理器将暂停当前任务，保存当前任务的上下文，并转移到中断或异常处理程序。如果特权级别相同或更低，则中断或异常被忽略。
- 不同优先级上，处理方式一样吗？
  
  不同优先级上，处理方式不一样。如果中断处理过程需要在较低的特权级别下执行，那么处理器会进行栈切换，即从当前执行任务的任务状态段（TSS）中获取新栈的段选择器和栈指针，并在新栈上保存被中断任务的栈段选择器和栈指针。如果中断处理过程可以在相同的特权级别下执行，那么处理器不会进行栈切换，而是在当前栈上保存被中断任务的执行状态。
- 如果发生堆栈切换，处理器会做哪些操作？

    1. 从当前执行任务的TSS中获取新栈的段选择器和栈指针

    2. 在新栈上保存被中断任务的栈段选择器和栈指针

    3. 在新栈上保存被中断任务的EFLAGS，CS和EIP寄存器

    4. 如果异常导致错误代码被保存，它将在新栈上推送错误代码

    5. 加载ISR的段选择器和偏移量到CS和EIP寄存器，并开始执行ISR1
- 如果没发生堆栈切换，处理器会做哪些操作？

    1. 在当前栈上保存被中断任务的EFLAGS，CS和EIP寄存器

    2. 如果异常导致错误代码被保存，它将在当前栈上推送错误代码

    3. 加载ISR的段选择器和偏移量到CS和EIP寄存器，并开始执行ISR
- 中断处理过程后，如何返回，处理器做了哪些操作？
  
  中断处理过程后，处理器会执行一条从中断返回指令（IRET），它会做以下操作：

    1. 如果发生了堆栈切换，从内核堆栈中弹出错误码（如果有的话），EIP，CS和EFLAGS寄存器的值，并恢复被中断任务的执行流。
    2. 如果发生了堆栈切换，从内核堆栈中弹出ESP和SS寄存器的值，并恢复被中断任务的堆栈空间。
    3. 如果没有发生堆栈切换，从当前堆栈中弹出错误码（如果有的话），EIP，CS和EFLAGS寄存器的值，并恢复被中断任务的执行流。
- 异常和中断处理过程的保护

  在处理异常和中断时，处理器会自动开启中断屏蔽位（IF标志），防止其他中断的干扰。此外，在处理异常和中断时，处理器还会自动将代码段选择符设置为内核代码段的选择符以保护处理程序的执行。为了确保异常和中断处理程序的正确性和稳定性，处理程序必须谨慎地处理与中断相关的状态和寄存器。

- 异常和中断处理过程的标志使用方式
    - EFLAGS寄存器中有两个重要的标志位：IF（interrupt enable flag）和TF（trap flag）。
    - IF标志位用来控制是否允许外部设备产生异步中断。当IF为1时，表示开启了中断；当IF为0时，表示屏蔽了中断。
    - TF标志位用来控制是否开启单步调试模式。当TF为1时，表示每执行一条指令就产生一个调试陷阱；当TF为0时，表示正常执行指令。
    - 处理器在响应异常和中断时，会自动清除IF标志位，以防止嵌套中断发生。同时，它也会清除TF标志位，以防止调试陷阱干扰正常的异常或者中断处理。
    - 处理器在从异常或者中断返回时，会自动恢复IF和TF标志位的原始值。
- 中断门与陷阱门的唯一区别是什么？

    1. 中断门与陷阱门的唯一区别是在调用中断处理程序之后，是否自动清除EFLAGS寄存器中的IF标志位。
    2. 中断门会自动清除IF标志位，以屏蔽其他异步中断的干扰。这样可以保证中断处理程序的独占性和原子性。
    3. 陷阱门不会自动清除IF标志位，以允许其他异步中断的响应。这样可以保证系统的实时性和响应性。
    4. 一般来说，中断门用于处理外部设备产生的异步中断，而陷阱门用于处理处理器自身产生的同步异常或者调试陷阱。